<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment - MobiComm</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- (Optional) Bootstrap CSS for quick styling -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/payment.css">
</head>

<body>

  <div class="payment-container">
    <!-- The main content will be replaced by JS upon submission -->
    <div id="paymentContent">
      <div class="row">
        <div class="payment-header mb-5">
          <h1>Payment Details</h1>
          <p>Complete your recharge process</p>
        </div>
        <!-- Payment Header -->
        <!-- Mobile Number Section -->
        <div class="col-sm-6">
          <div id="mobileSection" class="mb-4">
            <!-- Will be injected by JavaScript -->
          </div>
          <!-- Plan Summary -->
          <div id="planSummary" class="plan-summary mb-4">
            <!-- Will be injected by JavaScript -->
          </div>
        </div>
        <!-- Payment Method Section -->
        <div class="col-sm-6">
          <div class="payment-method mb-4">
            <label class="mb-2">Select Payment Method:</label><br>
            <div class="form-check form-check-inline">
              <!-- Default-checked to avoid "null" when reading .value -->
              <input class="form-check-input" type="radio" name="paymentMethod" id="upi" value="UPI" checked>
              <label class="form-check-label" for="upi">UPI</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="Card">
              <label class="form-check-label" for="card">Card</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="paymentMethod" id="wallet" value="Wallet">
              <label class="form-check-label" for="wallet">Wallet</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="paymentMethod" id="netbanking" value="NetBanking">
              <label class="form-check-label" for="netbanking">NetBanking</label>
            </div>
          </div>
          <!-- Payment Form -->
          <form id="paymentForm">
            <div class="payment-fields" class="w-100">
              <!-- UPI Fields (default visible) -->
              <div id="upiFields">
                <div class="mb-3">
                  <label for="upiId" class="form-label">UPI ID</label>
                  <input type="text" class="form-control" id="upiId" placeholder="example@upi">
                </div>
              </div>
              <!-- Card Fields (hidden by default) -->
              <div id="cardFields" style="display: none;">
                <div class="mb-3">
                  <label for="cardNumber" class="form-label">Card Number</label>
                  <input type="text" class="form-control" id="cardNumber" placeholder="XXXX-XXXX-XXXX-XXXX">
                </div>
                <div class="row mb-3">
                  <div class="col">
                    <label for="expiryDate" class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                  </div>
                  <div class="col">
                    <label for="cvv" class="form-label">CVV</label>
                    <input type="password" class="form-control" id="cvv" placeholder="XXX">
                  </div>
                </div>
              </div>
              <!-- Wallet Fields (hidden by default) -->
              <div id="walletFields" style="display: none;">
                <div class="mb-3">
                  <label for="walletId" class="form-label">Wallet ID</label>
                  <input type="text" class="form-control" id="walletId" placeholder="Enter your Wallet ID">
                </div>
              </div>
              <!-- NetBanking Fields (hidden by default) -->
              <div id="netbankingFields" style="display: none;">
                <div class="mb-3">
                  <label for="bank" class="form-label">Select Bank</label>
                  <select id="bank" class="form-select">
                    <option value="">Choose Bank</option>
                    <option value="sbi">SBI</option>
                    <option value="kotak">Kotak Mahindra</option>
                    <option value="canara">Canara</option>
                    <option value="hdfc">HDFC</option>
                    <option value="icici">ICICI</option>
                    <option value="axis">Axis</option>
                  </select>
                  <!-- Unique IDs for netbanking to avoid conflicts -->
                  <label for="netbankingUsername" class="form-label my-2">Username</label>
                  <input type="text" class="form-control" id="netbankingUsername" placeholder="username">
                  <label for="netbankingPassword" class="form-label">Password</label>
                  <input type="password" class="form-control" id="netbankingPassword" placeholder="password">
                </div>
              </div>
            </div>
            <button type="submit" class="btn-pay" id="payNowBtn">Pay Now</button>
          </form>
          <button id="payBtn" class="btn btn-success">Pay Now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS (optional) -->
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/payment.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
console.log("‚úÖ Page Loaded, Initializing Payment Setup...");

// Wait for Cashfree SDK to load
try {
    await waitForCashfreeSDK();
    console.log("‚úÖ Cashfree SDK Loaded Successfully");
} catch (error) {
    console.error("‚ùå Cashfree SDK Failed to Load:", error);
    alert("Failed to load Cashfree SDK. Check console for details.");
    return;
}

// Setup payment button
setupPaymentButton();
});

function waitForCashfreeSDK() {
return new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
        clearInterval(check);
        reject(new Error("Cashfree SDK not loaded after 10 seconds"));
    }, 10000);

    const check = setInterval(() => {
        if (window.Cashfree) {
            clearTimeout(timeout);
            clearInterval(check);
            resolve();
        }
    }, 500);
});
}

function setupPaymentButton() {
const payButton = document.getElementById("payBtn");

if (!payButton) {
    console.error("‚ùå Pay Button not found on the page!");
    alert("Payment button is missing. Cannot proceed.");
    return;
}

payButton.addEventListener("click", async function () {
    console.log("üõí Pay Button Clicked! Initiating Payment...");

    try {
        // Create order via backend
        const orderData = await createOrder();

        if (!orderData || !orderData.payment_session_id) {
            console.error("‚ö† Invalid Order Response:", orderData);
            alert("Failed to get payment session. Check console.");
            return;
        }

        console.log("‚úÖ Order Created Successfully. Session ID:", orderData.payment_session_id);

        // Initialize Cashfree SDK with sandbox environment
        const cashfree = Cashfree({
            mode: "sandbox" // Explicitly set to sandbox (use "production" for live)
        });

        // Open payment modal
        const checkoutResponse = cashfree.checkout({
            paymentSessionId: orderData.payment_session_id,
            redirect: false // Ensures modal, not redirect
        });

        console.log("üîç Checkout Initiated, Waiting for User Interaction...");

        // Handle the promise response
        checkoutResponse.then(() => {
            console.log("‚úÖ Payment Modal Closed. Check payment status if needed.");
        }).catch(error => {
            console.error("‚ùå Payment Modal Error:", error);
            alert("Payment failed. Check console for details.");
        });

    } catch (error) {
        console.error("‚ùå Payment Process Failed:", error);
        alert("Payment process failed. Check console.");
    }
});
}

async function createOrder() {
console.log("üîÑ Creating Order with Backend...");

const orderPayload = {
    order_id: "order_" + Date.now(), // Unique order ID
    order_amount: 500,
    order_currency: "INR",
    customer_details: {
        customer_id: "12345",
        customer_name: "User",
        customer_email: "test@example.com",
        customer_phone: "9999999999"
    }
};

try {
    const response = await fetch("http://localhost:8087/api/payment/create-order", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(orderPayload),
    });

    const data = await response.json();
    console.log("‚úÖ Backend Response:", data);

    if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${JSON.stringify(data)}`);
    }

    if (!data.payment_session_id) {
        throw new Error("Missing payment_session_id in response");
    }

    return data;
} catch (error) {
    console.error("‚ùå Order Creation Failed:", error);
    throw error;
}
}
</script>
  <script>

    document.addEventListener("DOMContentLoaded", function () {
      // Get all radio buttons and payment field divs
      const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
      const upiFields = document.getElementById("upiFields");
      const cardFields = document.getElementById("cardFields");
      const walletFields = document.getElementById("walletFields");
      const netbankingFields = document.getElementById("netbankingFields");

      // Function to show only the selected payment field
      function showPaymentFields(selectedMethod) {
        upiFields.style.display = selectedMethod === "UPI" ? "block" : "none";
        cardFields.style.display = selectedMethod === "Card" ? "block" : "none";
        walletFields.style.display = selectedMethod === "Wallet" ? "block" : "none";
        netbankingFields.style.display = selectedMethod === "NetBanking" ? "block" : "none";
      }

      // Attach event listeners to radio buttons
      paymentMethods.forEach((radio) => {
        radio.addEventListener("change", function () {
          showPaymentFields(this.value);
        });
      });

      // Set the default view based on the pre-checked radio button
      const defaultMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      showPaymentFields(defaultMethod);
    });

  </script>
</body>

</html>